<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pronounce</title>
  <style>
    body{font-family:system-ui;margin:0;display:grid;place-items:center;min-height:100vh;padding:20px}
    .card{max-width:560px;width:100%;border:1px solid #ddd;border-radius:14px;padding:18px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .word{font-size:30px;font-weight:800;margin:10px 0 12px;word-break:break-word}
    button, select{padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#fff;font-weight:700}
    button{cursor:pointer}
    .muted{opacity:.75;font-size:12px;margin-top:10px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="card">
    <div class="top">
      <div style="font-weight:800">Pronunciation</div>
      <select id="voiceSel" title="Voice"></select>
    </div>

    <div class="word" id="w">—</div>

    <div class="row">
      <button id="speakBtn">▶ Speak</button>
      <button id="repeatBtn">↻ Repeat x2</button>
    </div>

    <div class="muted" id="msg"></div>
  </div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  const word = (qs.get("word") || "").trim();
  const lang = (qs.get("lang") || "en-US").trim();

  const wEl = document.getElementById("w");
  const msg = document.getElementById("msg");
  const speakBtn = document.getElementById("speakBtn");
  const repeatBtn = document.getElementById("repeatBtn");
  const voiceSel = document.getElementById("voiceSel");

  if (!word) {
    wEl.textContent = "No word provided";
    speakBtn.disabled = true;
    repeatBtn.disabled = true;
    msg.textContent = "Open with ?word=YOURWORD (e.g. ?word=test&lang=en-US).";
    return;
  }

  wEl.textContent = word;

  function loadVoices() {
    if (!("speechSynthesis" in window)) {
      msg.textContent = "Speech not supported in this browser.";
      speakBtn.disabled = true;
      repeatBtn.disabled = true;
      return;
    }

    const voices = speechSynthesis.getVoices() || [];
    voiceSel.innerHTML = "";

    // Filter by language first; fallback to all voices
    const preferred = voices.filter(v => (v.lang || "").toLowerCase().startsWith(lang.toLowerCase().split("-")[0]));
    const list = preferred.length ? preferred : voices;

    list.forEach((v, i) => {
      const opt = document.createElement("option");
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSel.appendChild(opt);
    });

    msg.textContent = preferred.length
      ? `Using voices matching ${lang}. Tap Speak.`
      : `No matching voice for ${lang}; showing all voices.`;
  }

  function speak(times = 1) {
    if (!("speechSynthesis" in window)) return;
    speechSynthesis.cancel();

    const voices = speechSynthesis.getVoices() || [];
    const chosenName = voiceSel.value;
    const chosen = voices.find(v => v.name === chosenName);

    for (let i = 0; i < times; i++) {
      const u = new SpeechSynthesisUtterance(word);
      u.lang = lang;
      if (chosen) u.voice = chosen;
      speechSynthesis.speak(u);
    }
  }

  speakBtn.addEventListener("click", () => speak(1));
  repeatBtn.addEventListener("click", () => speak(2));

  // Voices load asynchronously in Chrome
  loadVoices();
  if ("speechSynthesis" in window) {
    speechSynthesis.onvoiceschanged = loadVoices;
  }

  // Try a gentle auto-speak (some phones require a tap anyway)
  setTimeout(() => speak(1), 250);
})();
</script>
</body>
</html>
