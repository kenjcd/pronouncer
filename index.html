<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pronounce</title>
  <style>
    body{font-family:system-ui;margin:0;display:grid;place-items:center;min-height:100vh;padding:20px}
    .card{max-width:560px;width:100%;border:1px solid #ddd;border-radius:14px;padding:18px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .word{font-size:32px;font-weight:900;margin:10px 0 14px;word-break:break-word}
    button, select{padding:10px 12px;border-radius:10px;border:1px solid #ccc;background:#fff;font-weight:700}
    button{cursor:pointer}
    .muted{opacity:.75;font-size:12px;margin-top:10px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="card">
    <div class="top">
      <div style="font-weight:900">Pronunciation</div>
      <select id="voiceSel" title="Voice"></select>
    </div>

    <div class="word" id="w">—</div>

    <div class="row">
      <button id="speakBtn">▶ Speak</button>
      <button id="repeatBtn">↻ Repeat x2</button>
      <button id="stopBtn">■ Stop</button>
    </div>

    <div class="muted" id="msg"></div>
  </div>

<script>
(() => {
  const qs = new URLSearchParams(location.search);
  const word = (qs.get("word") || "").trim();
  const lang = (qs.get("lang") || "en-US").trim();

  const wEl = document.getElementById("w");
  const msg = document.getElementById("msg");
  const speakBtn = document.getElementById("speakBtn");
  const repeatBtn = document.getElementById("repeatBtn");
  const stopBtn = document.getElementById("stopBtn");
  const voiceSel = document.getElementById("voiceSel");

  if (!("speechSynthesis" in window)) {
    wEl.textContent = "Speech not supported";
    msg.textContent = "Use Chrome / Edge / Safari (most phones support it).";
    speakBtn.disabled = repeatBtn.disabled = stopBtn.disabled = true;
    return;
  }

  if (!word) {
    wEl.textContent = "No word provided";
    msg.textContent = "Open with ?word=test&lang=en-US (your sheet will generate this).";
    speakBtn.disabled = repeatBtn.disabled = stopBtn.disabled = true;
    return;
  }

  wEl.textContent = word;

  function loadVoices() {
    const voices = speechSynthesis.getVoices() || [];
    voiceSel.innerHTML = "";

    const base = lang.toLowerCase().split("-")[0];
    const preferred = voices.filter(v => (v.lang || "").toLowerCase().startsWith(base));
    const list = preferred.length ? preferred : voices;

    list.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.name;
      opt.textContent = `${v.name} (${v.lang})`;
      voiceSel.appendChild(opt);
    });

    msg.textContent = preferred.length
      ? `Voice set for ${lang}. Tap Speak.`
      : `No matching voice for ${lang}; showing all voices.`;
  }

  function speak(times=1) {
    speechSynthesis.cancel();
    const voices = speechSynthesis.getVoices() || [];
    const chosen = voices.find(v => v.name === voiceSel.value);

    for (let i=0; i<times; i++) {
      const u = new SpeechSynthesisUtterance(word);
      u.lang = lang;
      if (chosen) u.voice = chosen;
      speechSynthesis.speak(u);
    }
  }

  speakBtn.addEventListener("click", () => speak(1));
  repeatBtn.addEventListener("click", () => speak(2));
  stopBtn.addEventListener("click", () => speechSynthesis.cancel());

  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;

  // try auto-speak (some phones require user tap — that's normal)
  setTimeout(() => speak(1), 250);
})();
</script>
</body>
</html>
